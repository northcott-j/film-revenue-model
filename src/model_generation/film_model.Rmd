---
title: "Film Revenue Model"
output: html_notebook
---
<strong>Business understanding</strong><br>
<a target="_blank" href="http://blog.jdnorthcott.com/2017/11/ready-set-go.html">Project About</a><br><br>

<strong>Data understanding</strong><br>
<a target="_blank" href="http://blog.jdnorthcott.com/2017/11/python-scraper-brain-dump.html">Inital Brain Dump of Python</a><br>
<a target="_blank" href="http://blog.jdnorthcott.com/2017/11/r-brain-dump.html">Initial Brain Dump of R</a><br><br>

<strong>Data preparation</strong><br>
<a target="_blank" href="http://blog.jdnorthcott.com/2017/11/implementing-python-scraper.html">Python Scraping Day One</a><br>
<a target="_blank" href="http://blog.jdnorthcott.com/2017/12/implementing-python-scraper-day-two.html">Python Scraping Day Two</a><br>
<a target="_blank" href="http://blog.jdnorthcott.com/2017/12/implementing-python-scraper-day-three.html">Python Scraping Day Three</a><br><br>
Summary:<br>
<p>I ran into a bunch of issues while scraping the data. Those three blog posts show what I worked on each day and some of the problems that I ran into. I tried to update them live with my exact thoughts and how I worked through, or avoided, the problems that came up with Data Prepartion.</p><br>
<a target="_blank" href="http://blog.jdnorthcott.com/2017/12/improvements-for-future-updates.html">Improvements</a><br>

<strong>Modeling</strong><br>
Backwards fitting

Evaluation
Fit
Test Methods
Test Results

<strong>Deployment</strong><br>
<p>I created a script that people can use to run the model. They need to have Python2.7 installed. Follow the directions in the README to use it. There is info on how to build the model from scratch as well in the README. I also have a blog post of potential improvements.</p>

<strong>Loading RMongo and linking to local database</strong>
```{r}
require(RMongo)
mg1 <- mongoDbConnect('ds4100')
dbShowCollections(mg1)
```


<strong>Building the data.frame</strong><br>
Remove the following columns as they aren't needed in the model<br>
X_id<br>
id<br>
FAILED<br>
mojo_id<br>
mojo_title<br>
stars<br>
metascore<br>
num_votes<br>
```{r}
films <- dbGetQuery(mg1, 'films_agg', "{'FAILED': false}") 
films <- subset(films, select = -c(X_id, id, FAILED, mojo_id, mojo_title, stars, metascore, num_votes))
```

<strong>Map all Distinct MPAA values and create a "dictionary"</strong>
```{r}
# Any non-sense values will be 0
# Go from NC-17 -> G being 1 - n
# Default value to return if string is something random
mpaa.int.default <- 0
mpaa.strings <- c(
    "NC-17",
    "R",
    "PG-13",
    "M/PG",
    "PG",
    "PASSED",
    "G"
)
mpaa.ints <- c(1:7)
# Setting the names of the ints to the corresponding ratings
names(mpaa.ints) <- mpaa.strings
# Test it out
mpaa.ints['R']
```

<strong>Write a function to remap MPAA values to a number</strong>
```{r}
# Takes a string rating and returns an int
mpaa.mapping<-function(rating) {
  if (rating %in% mpaa.strings) {
    return(mpaa.ints[rating])
  } else {
    return(mpaa.int.default)
  }
}

mpaa.mapping('R')   # 2
mpaa.mapping('XXX') # 0
```

<strong>Create new column in data.frame with mpaa ints</strong>
```{r}
string_ratings <- films$mpaa
string_ints <- sapply(string_ratings, mpaa.mapping)
films$mpaa_num <- string_ints
```

<strong>Fix Directors Age (negative or 0 values)</strong>
```{r}
avg_abv_zero_age <- mean(films$director_age[films$director_age > 0])
current_ages <- films$director_age
# Adjust the values to the average
adjusted_ages <- sapply(current_ages, function (a) if (a <= 0) {avg_abv_zero_age} else {a})
# Update the column
films$director_age <- adjusted_ages
```

<strong>Display Pairs Panels</strong>
```{r}
require(psych)
pairs.panels(films)
```


<strong>Check for Outliers in the following:</strong>
revenue<br>
length<br>
budget<br>
```{r}
outliers.high<-function(f_data) {
  f_sd <- sd(f_data, na.rm = TRUE)
  f_avg <- mean(f_data, na.rm = TRUE)
  return(f_data[f_data >= (f_avg + f_sd * 2)])
}

outliers.low<-function(f_data) {
  f_sd <- sd(f_data, na.rm = TRUE)
  f_avg <- mean(f_data, na.rm = TRUE)
  return(f_data[f_data <= (f_avg - f_sd * 2)])
}

# Revenue
print("Revenue")
print("High")
outliers.high(films$revenue)
print("Low")
outliers.low(films$revenue)

# Length
print("Length")
print("High")
outliers.high(films$length)
print("Low")
outliers.low(films$length)

# Budget
print("Budget")
print("High")
outliers.high(films$budget)
print("Low")
outliers.low(films$budget)
```


<strong>Possible fields to be included in the model. Going to use backwards fitting to design the model<br></strong>
<p>
revenue<br>
|<br>
v<br>
FILM SPECIFIC<br>
weekday<br>
day<br>
month<br>
budget<br>
length<br>
mpaa_num<br>

ACTOR SPECIFIC <br>
avg_actor_age<br>
max_actor_film_revenue<br>
avg_actor_film_revenue<br>
max_actor_film_votes<br>
avg_actor_film_votes<br>
max_actor_film_stars<br>
avg_actor_film_stars<br>
max_actor_film_appearances<br>
avg_actor_film_appearances<br>
max_actor_film_metascore<br>
avg_actor_film_metascore<br>

DIRECTOR SPECIFIC<br>
director_age<br>
director_number_of_films<br>
max_director_film_revenue<br>
avg_director_film_revenue<br>
max_director_film_votes<br>
avg_director_film_votes<br>
max_director_film_stars<br>
avg_director_film_stars<br>
max_director_film_metascore<br>
avg_director_film_metascore<br>
</p>

```{r}
revenue.lm <- lm(revenue ~ ., data=films)
summary(revenue.lm)

```

<strong>Divide data into training and test</strong>
<strong>Using a random 50/50 and 30/70 split</strong>
```{r}
train.rows.50.50 <- sample(1:nrow(films), round(nrow(films) / 2), replace=F)
train.50.50 <- films[train.rows.50.50,]
test.50.50 <- films[-train.rows.50.50,]

train.rows.30.70 <- sample(1:nrow(films), round(nrow(films) / 3.33), replace=F)
train.30.70 <- films[test.df.30.70,]
test.30.70 <- films[-test.df.30.70,]
```

<strong>Building the two test models</strong>
```{r}
lm.50.50 <- lm(revenue ~ ., data=train.50.50)
lm.30.70 <- lm(revenue ~ ., data=train.30.70)
```

<strong>Running the tests</strong>
```{r}
results.50.50 <- apply(test.50.50,1,function (x) predict(lm.50.50, x))
results.30.70 <- apply(test.30.70,1,function (x) predict(lm.30.70, x))
```

<strong>Checking % correct of both model tests</strong>
```{r}
diffs.50.50 <- test.50.50$revenue - results.50.50
diffs.30.70 <- test.30.70$revenue - results.30.70
avg.diff.50.50 <- mean(abs(diffs.50.50))
avg.diff.30.70 <- mean(abs(diffs.30.70))
```

